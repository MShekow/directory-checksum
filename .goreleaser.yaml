version: 2

builds:
  - env:
      - CGO_ENABLED=0
    goos:
      - linux
      - windows
      - darwin

    # Default is only 6.
    goarm:
      - 6
      - 7

    # Default is only v1.
    goamd64:
      - v1
      - v2
      - v3

# Disable compressing builds as ".tar.gz" file
archives:
  - formats:
      - binary

# Configure the checksums filename, to allow the attestation to pick up the correct filename
checksum:
  name_template: checksums.txt

sboms:
  # By default, SBOMs are only created for tar.gz archives, but above (see "archives" section) we overrode this
  # to only generate uncompressed binaries, thus we have to tell the SBOM generation to be applied to these binaries
  - artifacts: binary
    # By default, the files generated by Syft would cause clashes, because we are building multiple CPU versions(!)
    # (e.g. v1/v2/v3 for goamd64). For instance, there would be several SBOM files having the same name, e.g.:
    # cataloging cmd=syft artifact=dist/attestation-experiment_darwin_amd64_v1/attestation-experiment sbom=[attestation-experiment_1.52_darwin_amd64.sbom.json]
    # cataloging cmd=syft artifact=dist/attestation-experiment_darwin_amd64_v2/attestation-experiment sbom=[attestation-experiment_1.52_darwin_amd64.sbom.json]
    # and this would cause upload errors, such as
    # 422 Validation Failed [{Resource:ReleaseAsset Field:name Code:already_exists Message:}] name=attestation-experiment_1.52_darwin_amd64.sbom.json
    # To fix this issue, we simply configure Syft to instead use the artifact's filename as prefix
    documents:
      - "{{ .ArtifactName }}.sbom.json"
